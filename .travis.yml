language: generic
dist: trusty
sudo: true

branches:
  only:
  - master
  - ci-cd
  - /v(\d+\.)(\d)/

env:
  global:
    - SWARM_BZZ_API=https://swarm-public-staging.stg.swarm-gateways.net/

stages:
  - name: release
    if: tag IS present
  - name: deploy
    if: tag IS present

before_install:
  - sudo add-apt-repository -y ppa:ethereum/ethereum
  - sudo apt-get update
  - sudo apt-get install -y ethereum-swarm

before_script:
  - export RELEASE_FILE="swarm-home-$TRAVIS_TAG.tar.gz"

jobs:
  include:
    - stage: release
      script: echo "Deploying to GitHub releases ..."
      before_deploy:
        - >-
          tar -zcvf $RELEASE_FILE
              --exclude='.travis'
              --exclude='.git' .
      deploy:
        provider: releases
        api_key: "$RELEASE_OAUTH_TOKEN"
        file: "$RELEASE_FILE"
        skip_cleanup: true
        on:
          all_branches: true
          tags: true

    - stage: deploy
      script:
        - .travis/deploy.sh
